name: E2E Test

on: [push]

env:
  IMAGE_NAMESPACE: ghcr.io/sieve-project/action

jobs:
  e2e-test:
    runs-on: ubuntu-latest
    env:
      GOPATH: /home/runner/go
      KUBECONFIG: /home/runner/.kube/config
    steps:
      - uses: actions/checkout@v2
      - name: Setup Git
        run: |
          git config --global user.name "sieve"
          git config --global user.email "sieve@sieve.com"
      - name: Setup Go environment
        uses: actions/setup-go@v2.1.3
        with:
          go-version: 1.15
      - name: Setup Python
        uses: actions/setup-python@v2.2.2
        with:
          python-version: 3.7
      - name: Install Packages
        run: |
          sudo curl -s -L https://github.com/mikefarah/yq/releases/download/3.4.1/yq_linux_amd64 -o /usr/bin/yq
          sudo chmod a+x /usr/bin/yq
          sudo curl -s -L https://github.com/openshift/origin/releases/download/v3.11.0/openshift-origin-client-tools-v3.11.0-0cbc58b-linux-64bit.tar.gz | sudo tar -C /usr/bin  --wildcards  --strip-components 1 --wildcards -zxvpf - '*/oc' '*/kubectl'
          sudo curl -s https://get.helm.sh/helm-v3.2.4-linux-amd64.tar.gz | sudo tar -C /usr/bin --wildcards --strip-components 1 -zxvpf - '*/helm'
          helm
          yq
      - name: Install Python Packages
        run: |
          pip install kubernetes
          pip install pyyaml
      - name: Install Kind
        run: |
          go get sigs.k8s.io/kind
          kind
      - name: E2E Test
        run: |
          ./e2e-tests/one-pod/run
      - uses: actions/upload-artifact@v2
        with:
          name: log
          path: log